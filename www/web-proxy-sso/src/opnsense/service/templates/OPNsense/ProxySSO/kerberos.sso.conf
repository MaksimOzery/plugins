{% if helpers.exists('OPNsense.ProxySSO.EnableSSO') and OPNsense.ProxySSO.EnableSSO == '1' %}
{%      set ldaps = [] %}
{%      if helpers.exists('OPNsense.proxy.forward.authentication.method') %}
{%          for method in OPNsense.proxy.forward.authentication.method.split(",") %}
{%              for server in helpers.toList('system.authserver') %}
{%                  if server.type == 'ldap' and server.name == method %}
{%                      do ldaps.append(server) %}
{%                  endif %}
{%              endfor %}
{%          endfor %}
{%      endif %}
{%      if ldaps|length > 0 %}
{%          if ldaps|length == 1 %}
{%              set domain = [] %}
{%              for element in ldaps[0].ldap_basedn.split(",") %}
{%                  do domain.append(element.split("=")[1]) %}
{%              endfor %}
auth_param negotiate program /usr/local/libexec/squid/negotiate_kerberos_auth -i -s HTTP/{{system.hostname}}.{{domain|join(".")}}@{{domain|join(".")|upper}}
{%          else %}
auth_param negotiate program /usr/local/libexec/squid/negotiate_kerberos_auth -i -s GSS_C_NO_NAME
{%          endif %}
auth_param negotiate keep_alive on
{%          if helpers.exists('OPNsense.proxy.forward.authentication.children') %}
auth_param negotiate children {{OPNsense.proxy.forward.authentication.children}}
{%          endif %}
{%      endif %}
{% endif %}
